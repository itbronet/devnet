#!/bin/bash

set -euo pipefail

# --- Configuration ---
REPO_URL="https://github.com/zorp-corp/nockchain"
REPO_DIR="$HOME/nockchain"
ASSETS_DIR="$REPO_DIR/assets"
BRANCH="main"
TMUX_SESSION="nockminer"
PUBKEY="35TRFiYFy3GbwKV5eKriYA8AevHQpv9iuvCcgj46oKWpidJVJcNLFrAXii1hT6giAoU3ZDg8XuGwApdLKTT3EshcMxMNfEsvtMd1YkRVrvjc5dMhdSAHMyk6dkFxvsaMBa2R"

echo "[1/8] Cloning or updating repository..."
if [ -d "$REPO_DIR" ]; then
    cd "$REPO_DIR"
    git pull origin "$BRANCH"
else
    git clone --branch "$BRANCH" "$REPO_URL" "$REPO_DIR"
fi

cd "$REPO_DIR"

echo "[2/8] Ensuring assets directory exists..."
mkdir -p "$ASSETS_DIR"

echo "[3/8] Creating missing .jam files..."
create_jam() {
    local file="$1"
    local content="$2"
    if [ ! -f "$ASSETS_DIR/$file" ]; then
        echo "$content" > "$ASSETS_DIR/$file"
        echo "Created $file"
        JAM_CHANGED=true
    fi
}

JAM_CHANGED=false
create_jam "wal.jam" ':: Wallet logic sample\n|=  pubkey\n^-  tape\n"Wallet active for: " pubkey'
create_jam "miner.jam" ':: Mining logic sample\n|=  pubkey\n^-  tape\n"Mining using: " pubkey'
create_jam "dumb.jam" ':: Dumb logic sample\n|=  ~\n^-  tape\n"Hello, Nockchain!"'

echo "[4/8] Verifying .jam files..."
for f in wal.jam miner.jam dumb.jam; do
    if [ ! -s "$ASSETS_DIR/$f" ]; then
        echo "Error: Missing or empty asset: $f"
        exit 1
    fi
done
echo "[âœ”] All .jam files present."

if [ "$JAM_CHANGED" = true ]; then
    echo "[5/8] Committing new .jam files to GitHub..."
    cd "$REPO_DIR"
    git config user.name "nockbot"
    git config user.email "nockbot@localhost"
    git add assets/*.jam
    git commit -m "Add missing .jam kernel files"
    git push origin "$BRANCH"
else
    echo "[âœ”] No new .jam files to commit."
fi

echo "[6/8] Building the project..."
cargo build --release

echo "[7/8] Starting miner in tmux session..."
tmux kill-session -t "$TMUX_SESSION" 2>/dev/null || true
tmux new-session -d -s "$TMUX_SESSION" "cd $REPO_DIR && ./target/release/nockchain --mine --mining-pubkey $PUBKEY"

sleep 5

echo "[8/8] Checking wallet balance..."
BALANCE=$("$REPO_DIR/target/release/nockcli" wallet balance 2>/dev/null || echo "unknown")
echo "Wallet Balance: $BALANCE"

echo "âœ… Setup complete!"
echo "ðŸ‘‰ To monitor mining: tmux attach -t $TMUX_SESSION"
