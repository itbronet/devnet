#!/bin/bash

set -euo pipefail

# --- Configuration ---
REPO_URL="https://github.com/zorp-corp/nockchain"
PROJECT_DIR="$HOME/nockchain"
ASSET_DIR="$PROJECT_DIR/assets"
TMUX_SESSION="nockminer"
PUBKEY="35TRFiYFy3GbwKV5eKriYA8AevHQpv9iuvCcgj46oKWpidJVJcNLFrAXii1hT6giAoU3ZDg8XuGwApdLKTT3EshcMxMNfEsvtMd1YkRVrvjc5dMhdSAHMyk6dkFxvsaMBa2R"
LOG_FILE="$PROJECT_DIR/miner.log"

echo "[1/8] Installing Rust if missing..."
if ! command -v cargo &>/dev/null; then
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  source "$HOME/.cargo/env"
fi

echo "[2/8] Installing system packages..."
sudo apt-get update
sudo apt-get install -y git make build-essential clang llvm-dev libclang-dev tmux

echo "[3/8] Cloning or updating Nockchain..."
if [ ! -d "$PROJECT_DIR" ]; then
  git clone "$REPO_URL" "$PROJECT_DIR"
else
  cd "$PROJECT_DIR"
  git pull origin main
fi

mkdir -p "$ASSET_DIR"

echo "[4/8] Creating dummy .jam kernel files..."
cat > "$ASSET_DIR/wal.jam" << 'EOF'
[+*  %wallet
  =$
  $coin  @ud
  $owner @pub
]
EOF

cat > "$ASSET_DIR/miner.jam" << 'EOF'
[+*  %miner
  =$
  $difficulty @ud
  $timestamp  @da
]
EOF

cat > "$ASSET_DIR/dumb.jam" << 'EOF'
[+*  %dumb
  =$
  $id @ta
]
EOF

echo "[5/8] Verifying required assets..."
for f in wal.jam miner.jam dumb.jam; do
  if [ ! -f "$ASSET_DIR/$f" ]; then
    echo "âŒ Missing required asset: $f"
    exit 1
  fi
done

echo "[6/8] Building project..."
cd "$PROJECT_DIR"
cargo build --release

if [ ! -f "$PROJECT_DIR/target/release/nockchain" ]; then
    echo "âŒ Error: nockchain binary not found after build."
    exit 1
fi

if [ ! -f "$PROJECT_DIR/target/release/nockcli" ]; then
    echo "âŒ Error: nockcli binary not found after build."
    exit 1
fi

echo "[7/8] Killing existing tmux session if any..."
tmux kill-session -t "$TMUX_SESSION" 2>/dev/null || true

echo "[8/8] Launching miner in tmux..."
tmux new-session -d -s "$TMUX_SESSION" "cd $PROJECT_DIR && ./target/release/nockchain --mine --mining-pubkey $PUBKEY | tee -a $LOG_FILE"

sleep 5

BALANCE=$($PROJECT_DIR/target/release/nockcli wallet balance 2>/dev/null || echo "Unavailable")
echo "Wallet Balance: $BALANCE"
echo "$(date): Wallet Balance: $BALANCE" >> "$LOG_FILE"

echo "ðŸŽ‰ Miner is running in tmux session '$TMUX_SESSION'"
echo "ðŸ‘‰ To attach: tmux attach -t $TMUX_SESSION"
echo "ðŸ‘‰ Public Key: $PUBKEY"
